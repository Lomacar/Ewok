(()=>{window.Ewok={options:{noshadow:false,stylesheet:null},dependencies:[],classes:{},sharedModules:{},xref:xref,init:init};function init(options=this.options,selection="template"){let plates=document.querySelectorAll(selection);let templates=[...plates].map((x=>x.id)).filter((x=>x)).join(",");let used_templates=new Set([...document.querySelectorAll(templates)].map((x=>x.tagName.toLowerCase())));let ext_templates=[...document.querySelectorAll(selection)].filter((t=>t.hasAttribute("extends"))).map((x=>`[is=${x.id}]`)).join(",");if(ext_templates){let used_ext_templates=new Set([...document.querySelectorAll(ext_templates)].map((x=>x.getAttribute("is"))));if(used_ext_templates.size)used_templates=new Set([...used_templates,...used_ext_templates])}used_templates.forEach((t=>{let frag=document.getElementById(t).content;let subcomponents=new Set([...frag.querySelectorAll(templates)].map((x=>x.tagName.toLowerCase())));if(subcomponents.size)subcomponents.forEach((sc=>{Ewok.dependencies.push([sc,t]);used_templates.add(sc)}))}));let templateDependencies=new Graph([...used_templates],Ewok.dependencies);used_templates=topologicalSort(templateDependencies);used_templates.forEach((x=>{createTemplate(x,options)}))}const hooks=`let host, root, xref, xdata; \n    export function EwokAttach(){\n        host = this\n        root = host.root\n        xref = Ewok.xref.bind(root)\n        xdata = host.xdata\n    };\n    `;function createTemplate(elementName,options){const templateElement=document.getElementById(elementName);const templateContent=templateElement.content;const templateAttrs=new Map(Object.entries([...templateElement.attributes].filter((a=>a.name!="id")).reduce(((obj,a)=>{obj[a.name]=a.value;templateElement.removeAttribute(a.name);return obj}),{})));let promises=[];let templateScript=templateContent.querySelectorAll("script");let sharedModules;let privateModules;if(templateScript.length){sharedModules=[...templateScript].filter((x=>x.hasAttribute("shared")));privateModules=[...templateScript].filter((x=>!x.hasAttribute("shared")));sharedModules=sharedModules.reduce(((t,m)=>t+m.text),"");privateModules=privateModules.reduce(((t,m)=>t+m.text),"");sharedModules&&blobify(sharedModules,true);templateScript.forEach((s=>s.remove()))}function blobify(code,shared=false){let hookcode=!shared?hooks:"";let blob=new Blob([hookcode+code],{type:"application/javascript"});promises[1+shared]=import(URL.createObjectURL(blob));URL.revokeObjectURL(blob)}console.debug("ðŸš© "+elementName);const ext=templateAttrs.get("extends");let extType;if(ext){const invalid=()=>warn(`${ext} is not a valid element to extend.`);try{const extEl=document.createElement(ext);if(extEl.__proto__==HTMLUnknownElement.prototype){throw"invalid element type"}else{extType=extEl.__proto__.constructor}}catch{invalid();ext=null}}Ewok.classes[elementName]=class extends(extType||HTMLElement){connectedCallback(){let event=new Event("connecting",{node:this});this.dispatchEvent(event);console.debug("âš¡ "+elementName);this.setAttribute("loading","");for(const a of templateAttrs){if(!this.hasAttribute(a[0])){this.setAttribute(a[0],a[1])}}if(!this.hasAttribute("noshadow")&&!options?.noshadow){this.attachShadow({mode:"open"})}let attachPoint=options?.noshadow?this:this.shadowRoot||this;this.root=attachPoint;this.xref=xref.bind(this.root);let host=this.parentElement||this.getRootNode().host;let nested=host.hasOwnProperty("props");let clone=templateContent.cloneNode(true);let temp=clone.querySelector("[temp]");temp=this.querySelector("[temp]")||temp;temp&&attachPoint.appendChild(temp);let THIS=this;this.propsReady=new Promise((function(resolve,reject){THIS.resolver=resolve;THIS.rejecter=reject}));let parentPromise=nested?host.propsReady:null;promises[0]=parentPromise;if(privateModules){blobify(privateModules)}Promise.all(promises).then((results=>{console.debug("âœ¨ "+elementName);let privateModules=results[1];let sharedModules=results[2];let thismodule={...sharedModules,...privateModules};sharedModules&&(Ewok.sharedModules[elementName]=sharedModules);let hostProps=nested?host.props:null;let thisDataset={...this.dataset};for(let p in thisDataset){let v=thisDataset[p];if(v[0]=="*"){let sliced=v.slice(1);thisDataset[p]=getObjPath(sliced,window)}}this.props={...hostProps,...thismodule,...thisDataset};if(Ewok.Alpine)this.xdata=Alpine.evaluate(this,"$data");if(this.xdata)this.props.xdata=this.xdata;connectThings.call(this,clone);this.shadowRoot&&connectThings.call(this,this);function connectThings(start){start.querySelectorAll("*").forEach((el=>{[...el.attributes].forEach((a=>{let attr=a.value;if(/^(@|:|x-)/.test(a.name))return;let oldattr;do{oldattr=attr;attr=attr.replace(/~([\w$.]+\(.*\))/g,"this.props.$1")}while(attr!=oldattr);el.setAttribute(a.name,attr)}))}))}this.resolver();privateModules&&privateModules.EwokAttach.apply(this);clone.querySelectorAll("*").forEach((el=>{el.props=this.props}));this.shadowRoot&&this.querySelectorAll("*").forEach((el=>{el.props=this.props}));injectContent.call(this,clone,attachPoint,!!temp);if(thismodule&&thismodule.mount)thismodule.mount.apply(this,null);Ewok.Alpine&&!nested&&this.shadowRoot&&Alpine.initTree(this.shadowRoot);Ewok.Alpine&&this.shadowRoot&&Alpine.initTree(this);interpolate(attachPoint,this.props);this.shadowRoot&&interpolate(this,this.props);this.removeAttribute("loading");console.debug("âœ… "+elementName)}));event=new Event("connected",{detail:elementName});event.elem=elementName;window.dispatchEvent(event)}disconnectedCallback(){console.debug("ðŸ’¥",elementName);delete this.props}};customElements.define(elementName,Ewok.classes[elementName],ext&&{extends:ext});console.debug("ðŸ§¾ "+elementName)}function injectContent(content,attachPoint,hasTemp){if(this.shadowRoot&&Ewok.options?.stylesheet){let stylelink=document.createElement("link");stylelink.setAttribute("rel","stylesheet");stylelink.setAttribute("href",options.stylesheet);this.shadowRoot.appendChild(stylelink)}attachPoint.appendChild(content);hasTemp&&attachPoint.querySelectorAll("[temp]").forEach((el=>el.remove()))}function interpolate(node,props,recur){if(node.nodeName=="#document-fragment"){for(let child of[...node.childNodes])interpolate(child,props,true);return}if(node.nodeName=="#text"){let text=node.textContent;if(text.includes("{{"))node.textContent=handlebars(text,props)}else if(node.nodeType==2){let text=node.value;if(text.includes("{{"))node.value=handlebars(text,props)}else if(node.nodeType===1&&node.nodeName!="SCRIPT"&&!(recur&&customElements.get(node.tagName.toLowerCase()))){let original_xdata=props?props.xdata:undefined;if(Ewok.Alpine&&original_xdata&&(node.hasAttribute("x-data")||node.hasAttribute("x-for"))){props.xdata=Alpine.evaluate(node,"$data")}node.childNodes&&[...node.childNodes].forEach((n=>{interpolate(n,props)}));[...node.attributes].forEach((attr=>{interpolate(attr,props,true)}));props&&(props.xdata=original_xdata)}}function handlebars(template,variables,fallback){const regex=/\{\{[^{<"']+}}/g;return template.replace(regex,(match=>{const path=match.slice(2,-2).split("|");return getObjPath(path[0].trim(),variables,path[1])}))}function getObjPath(path,obj,fallback=""){if(path[0]=="*"){obj=window;path=path.slice(1)}const pathArray=path.split(".");let result=pathArray.reduce(((res,key)=>(typeof res[key]=="function"?res[key]():res[key])??fallback),obj);if(Ewok.options.debug&&result===""){warn(`Interpolation of {{${path}}} failed with no fallback.`)}return result}function xref(query){return this.querySelector(`[x-ref=${query}]`)}function warn(msg){console.warn("ðŸ™ˆ Ewok: "+msg)}function shadowDive(el,selector,func){let root=el.shadowRoot||el;root.querySelector(selector)&&func(root.querySelector(selector),root);[...root.children].map((el=>shadowDive(el,selector,func)))}function Graph(nodes,edges){const adjacencyList=this.adjacencyList=new Map;const independentNodes=this.independentNodes=new Set(nodes);this.nodes=nodes;this.addNode=function(node){adjacencyList.set(node,new Set)};this.addEdge=function(dependency,dependent){try{adjacencyList.get(dependency).add(dependent);return true}catch(error){console.warn("Invalid edge.");return false}};if(nodes&&nodes.length){nodes.forEach(this.addNode);if(edges&&edges.length){edges.forEach((edge=>{if(this.addEdge(...edge))independentNodes.delete(edge[1])}))}}return this}function topologicalSort(graph){const L=[];const inDegree={};for(const v of graph.nodes){for(neighbor of graph.adjacencyList.get(v)){inDegree[neighbor]=inDegree[neighbor]+1||1}}let index=0;let queue=new Set(graph.independentNodes);while(queue.size){let n=queue.values().next().value;queue.delete(n);L.push(n);index++;graph.adjacencyList.get(n).forEach((m=>{inDegree[m]--;if(inDegree[m]===0){queue.add(m)}}))}if(index!==graph.nodes.length){console.warn("Dependecy cycle detected.")}return L}class EwokImportContent extends HTMLElement{constructor(){super()}get path(){return this.getAttribute("src")||""}get loading(){return this.getAttribute("loading")||"auto"}connectedCallback(){this.innerHTML=`\n                <iframe src="${this.path}" loading="${this.loading}" hidden></iframe>\n            `;const frame=this.querySelector("iframe");frame.addEventListener("load",(evt=>{const children=[...frame.contentDocument.querySelectorAll("template[id]")];children.forEach((child=>frame.before(child)));frame.remove()}))}}customElements.define("ewok-import",EwokImportContent);document.addEventListener("alpine:init",(()=>{Alpine.magic("props",(el=>el.props));Alpine.magic("host",(el=>el.host));Alpine.magic("_",(el=>(data=el.props)=>{if(!data){warn(`No data passed to $_ at ${el.nodeName}`);return}el.tmplt=el.tmplt||el.innerHTML;let processedText;const original_xdata=data.xdata;if(data&&data==el.props){data.xdata=Alpine.evaluate(el,"$data")}else if(!data){data=Alpine.evaluate(el,"$data")}processedText=handlebars(el.tmplt,data);data.xdata=original_xdata;return processedText}))}));document.addEventListener("alpine:initialized",(()=>{Ewok.Alpine=true;if(document.readyState==="complete"){init()}else{window.onload=function(){init()}}}));window.onload=function(){!Ewok.Alpine&&init()}})();